## è¯´ä¸€è¯´webpackåˆ°åº•åšäº†ä»€ä¹ˆ?
## è¯´ä¸€è¯´webpackæ‰“åŒ…çš„æµç¨‹


## ğŸ˜Š ç”¨è¿‡å“ªäº›plugin?


## ğŸ˜Š ç”¨è¿‡é‚£äº›loader?

## ğŸ˜Š è¯´ä¸€è¯´Loaderå’ŒPluginçš„åŒºåˆ«?

![image.png](https://i.loli.net/2021/03/30/PkRF3SUhJ5EcjWY.png)
### Loader

`Loaderæœ¬è´¨æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚`Loaderçš„èŒè´£æ˜¯å•ä¸€çš„ï¼Œåªéœ€è¦å…³å¿ƒè¾“å…¥å’Œè¾“å‡ºã€‚`Loader`åœ¨ç”Ÿæˆ`bundle`çš„æœŸé—´å’Œä¹‹å‰å·¥ä½œï¼Œåœ¨å•ä¸ªæ–‡ä»¶çš„çº§åˆ«ä¸Šå·¥ä½œã€‚ä¸€ä¸ªæ–‡ä»¶å¯ä»¥é“¾å¼çš„ï¼Œç»è¿‡å¤šä¸ª`Loader`è½¬æ¢ã€‚`Loader`ä¸ä¾èµ–ä¸äº‹ä»¶ã€‚`Loader`åœ¨`module.rules`ä¸­é…ç½®ã€‚

### Plugin

`Plugin`åœ¨`bundle`å’Œ`chunk`çº§åˆ«ä¸Šå·¥ä½œï¼Œé€šå¸¸åœ¨`bundle`ç”Ÿæˆçš„æœ«å°¾å·¥ä½œã€‚`Plugin`æ¯”`Loader`å…·æœ‰æ›´å¼ºå¤§çš„æ§åˆ¶èƒ½åŠ›ã€‚`Plugin`ä¾èµ–äº‹ä»¶ï¼Œ`Plugin`ä¼šåœ¨ç‰¹å®šçš„æ—¶åˆ»ï¼ˆç›‘å¬ç‰¹å®šçš„äº‹ä»¶ï¼‰åŠ å…¥æ‰“åŒ…çš„è¿‡ç¨‹ï¼Œæ”¹å˜è¾“å‡ºçš„ç»“æœã€‚`Plugin`åœ¨`plugins`ä¸­é…ç½®ã€‚

## ğŸ˜Š ä»€ä¹ˆæ˜¯sourceMap? å¦‚ä½•é…ç½®sourceMap? sourceMapæ–‡ä»¶çš„æ ¼å¼ä½ äº†è§£å—?

### ä»€ä¹ˆæ˜¯sourceMap?

æ‰“åŒ…å‹ç¼©åçš„ä»£ç æ²¡æœ‰å¯è¯»æ€§ï¼Œæ— æ³•è¿›è¡Œdebugã€‚è€ŒsourceMapæ˜¯ä»å·²è½¬æ¢çš„ä»£ç æ˜ å°„åˆ°åŸå§‹æºçš„æ–‡ä»¶ï¼Œä½¿æµè§ˆå™¨èƒ½å¤Ÿé‡æ„åŸå§‹æºå¹¶åœ¨è°ƒè¯•å™¨ä¸­æ˜¾ç¤ºé‡å»ºçš„åŸå§‹æºã€‚å¦‚æœé™æ€ç›®å½•ä¸­åŒ…å«sourceMapï¼Œå¹¶ä¸”æµè§ˆå™¨æ‰“å¼€äº†å¼€å‘è€…å·¥å…·ï¼Œæµè§ˆå™¨æ‰ä¼šåŠ è½½sourceMapã€‚

### å¦‚ä½•é…ç½®sourceMap?

åœ¨é…ç½®æ–‡ä»¶çš„`devtool`å±æ€§ä¸­é…ç½®sourceMapã€‚å¸¸è§çš„é…ç½®é¡¹ï¼š

- `hidden-source-map`, å€ŸåŠ©ç¬¬ä¸‰æ–¹é”™è¯¯ç›‘æ§å¹³å°Sentryä½¿ç”¨
- `nosources-source-map`, åˆ›å»ºçš„sourcemapä¸åŒ…å«sourcesContent(æºä»£ç å†…å®¹)ã€‚å®ƒå¯ä»¥ç”¨æ¥æ˜ å°„å®¢æˆ·ç«¯ä¸Šçš„å †æ ˆè·Ÿè¸ªï¼Œè€Œæ— é¡»æš´éœ²æ‰€æœ‰çš„æºä»£ç ã€‚ä½ å¯ä»¥å°†sourcemapæ–‡ä»¶éƒ¨ç½²åˆ°webæœåŠ¡å™¨ã€‚
- `sourcemap`,  æ•´ä¸ªsourceMapä½œä¸ºä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ç”Ÿæˆã€‚å®ƒä¸ºbundleæ·»åŠ äº†ä¸€ä¸ªå¼•ç”¨æ³¨é‡Šï¼Œä»¥ä¾¿å¼€å‘å·¥å…·çŸ¥é“åœ¨å“ªé‡Œå¯ä»¥æ‰¾åˆ°å®ƒã€‚

ç­‰ç­‰â€¦â€¦

### sourceMapæ–‡ä»¶çš„æ ¼å¼ä½ äº†è§£å—?

```js
{
  "version": 3, // SourceMapçš„ç‰ˆæœ¬
  "sources": [ // è½¬æ¢å‰çš„æ–‡ä»¶æ¥æº
    "webpack:///webpack/universalModuleDefinition",
    "webpack:///webpack/bootstrap"
  ],
  "names": [], // è½¬æ¢å‰çš„å˜é‡å
  "mappings": "AAAA,AACA;AACA", // ä½ç½®ä¿¡æ¯
  "file": "react-ui-components-library.js", // è½¬æ¢åçš„æ–‡ä»¶å
  "sourceRoot": "" // è½¬æ¢å‰çš„æ–‡ä»¶ç›®å½•,
  "sourcesContent":[] // åŸå§‹æ–‡ä»¶å†…å®¹
}
```

å¯¹äºå‹ç¼©åæºä»£ç ï¼Œéœ€è¦åœ¨æœ«å°¾æ·»åŠ `//# sourceURL=/path/to/file.js.map`æ³¨é‡Šåï¼Œæµè§ˆå™¨å°±ä¼šé€šè¿‡`sourceURL`å»æŸ¥æ‰¾å¯¹åº”çš„`sourceMap`æ–‡ä»¶ï¼Œé€šè¿‡è§£é‡Šå™¨è§£æåï¼Œå®ç°æºç å’Œæ··æ·†ä»£ç ä¹‹é—´çš„æ˜ å°„ã€‚å› æ­¤`sourceMap`å…¶å®ä¹Ÿæ˜¯ä¸€é¡¹éœ€è¦æµè§ˆå™¨æ”¯æŒçš„æŠ€æœ¯ã€‚

## ğŸ˜Š å¦‚ä½•ç¼–å†™Loaderå—?ç¼–å†™è¿‡Loaderå—?

ä¸€ä¸ª`Loader`çš„èŒè´£æ˜¯å•ä¸€çš„ï¼Œåªéœ€è¦å®Œæˆä¸€ç§è½¬æ¢ã€‚ å¦‚æœä¸€ä¸ªæºæ–‡ä»¶éœ€è¦ç»å†å¤šæ­¥è½¬æ¢æ‰èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œå°±é€šè¿‡å¤šä¸ª `Loader`å»è½¬æ¢ã€‚ åœ¨è°ƒç”¨å¤šä¸ª`Loader`å»è½¬æ¢ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œæ¯ä¸ª`Loader`ä¼šé“¾å¼çš„é¡ºåºæ‰§è¡Œï¼Œ ç¬¬ä¸€ä¸ª`Loader`å°†ä¼šæ‹¿åˆ°éœ€å¤„ç†çš„åŸå†…å®¹ï¼Œä¸Šä¸€ä¸ª`Loader`å¤„ç†åçš„ç»“æœä¼šä¼ ç»™ä¸‹ä¸€ä¸ªæ¥ç€å¤„ç†ï¼Œæœ€åçš„`Loader`å°†å¤„ç†åçš„æœ€ç»ˆç»“æœè¿”å›ç»™`Webpack`ã€‚

ç”±äº`Webpack`æ˜¯è¿è¡Œåœ¨`Node.js`ä¹‹ä¸Šçš„ï¼Œä¸€ä¸ª`Loader`å…¶å®å°±æ˜¯ä¸€ä¸ª`Node.js`æ¨¡å—ï¼Œè¿™ä¸ªæ¨¡å—éœ€è¦å¯¼å‡ºä¸€ä¸ªå‡½æ•°ã€‚ è¿™ä¸ªå¯¼å‡ºçš„å‡½æ•°çš„å·¥ä½œå°±æ˜¯è·å¾—å¤„ç†å‰çš„åŸå†…å®¹ï¼Œå¯¹åŸå†…å®¹æ‰§è¡Œå¤„ç†åï¼Œè¿”å›å¤„ç†åçš„å†…å®¹ã€‚

ä¸€ä¸ªæœ€ç®€å•çš„`Loader`æºç å¦‚ä¸‹ï¼š

```js
module.exports = function(source) {
  // sourceä¸ºcompilerä¼ é€’ç»™ Loader çš„ä¸€ä¸ªæ–‡ä»¶çš„åŸå†…å®¹
  // è¯¥å‡½æ•°éœ€è¦è¿”å›å¤„ç†åçš„å†…å®¹ï¼Œè¿™é‡Œç®€å•èµ·è§ï¼Œç›´æ¥æŠŠåŸå†…å®¹è¿”å›äº†ï¼Œç›¸å½“äºè¯¥ Loader æ²¡æœ‰åšä»»ä½•è½¬æ¢
  return source;
};
```

`Loader`ä¸­çš„`this`ä¸Šä¸‹æ–‡ç”±`Webpack`æä¾›ï¼Œå¯ä»¥é€šè¿‡`this`å¯¹è±¡æä¾›çš„ç›¸å…³å±æ€§ï¼Œè·å–å½“å‰`Loader`éœ€è¦çš„å„ç§ä¿¡æ¯æ•°æ®ã€‚

```js
module.exports = function(source) {
    const content = doSomeThing2JsString(source);
    
    // å¦‚æœ loader é…ç½®äº† options å¯¹è±¡ï¼Œé‚£ä¹ˆthis.queryå°†æŒ‡å‘ options
    const options = this.query;
    
    /*
     * this.callback å‚æ•°ï¼š
     * errorï¼šError | nullï¼Œå½“æ— æ³•è½¬æ¢åŸå†…å®¹æ—¶ï¼Œç»™ Webpack è¿”å›ä¸€ä¸ª Error
     * contentï¼šString | Bufferï¼ŒåŸå†…å®¹è½¬æ¢åçš„å†…å®¹
     * sourceMapï¼šç”¨äºæŠŠè½¬æ¢åçš„å†…å®¹å¾—å‡ºåŸå†…å®¹çš„ Source Mapï¼Œæ–¹ä¾¿è°ƒè¯•
     * abstractSyntaxTree: å¦‚æœæœ¬æ¬¡è½¬æ¢ä¸ºåŸå†…å®¹ç”Ÿæˆäº† AST è¯­æ³•æ ‘ï¼Œå¯ä»¥æŠŠè¿™ä¸ª AST è¿”å›, ä»¥æ–¹ä¾¿ä¹‹åéœ€è¦ AST çš„ Loader å¤ç”¨è¯¥ ASTï¼Œä»¥é¿å…é‡å¤ç”Ÿæˆ ASTï¼Œæå‡æ€§èƒ½
     */
    this.callback(null, content);
}
```

- this.query, å¯ä»¥è·å–`Loader`çš„`options`å¯¹è±¡ã€‚
- this.callback, å¯ä»¥è¿”å›é™¤äº†å†…å®¹ä¹‹å¤–çš„ä¸œè¥¿ã€‚
- this.contextï¼Œå½“å‰å¤„ç†æ–‡ä»¶çš„æ‰€åœ¨ç›®å½•ï¼Œå‡å¦‚å½“å‰ Loader å¤„ç†çš„æ–‡ä»¶æ˜¯ /src/main.jsï¼Œåˆ™ this.context å°±ç­‰äº /src

ç­‰ç­‰...
### å¼‚æ­¥çš„Loader

æœ‰äº›åœºæ™¯ä¸‹è½¬æ¢çš„æ­¥éª¤åªèƒ½æ˜¯å¼‚æ­¥å®Œæˆçš„ï¼Œä¾‹å¦‚ä½ éœ€è¦é€šè¿‡ç½‘ç»œè¯·æ±‚æ‰èƒ½å¾—å‡ºç»“æœï¼Œå¦‚æœé‡‡ç”¨åŒæ­¥çš„æ–¹å¼ç½‘ç»œè¯·æ±‚å°±ä¼šé˜»å¡æ•´ä¸ªæ„å»ºï¼Œå¯¼è‡´æ„å»ºéå¸¸ç¼“æ…¢ã€‚

```js
module.exports = function(source) {
    // å‘Šè¯‰ Webpack æœ¬æ¬¡è½¬æ¢æ˜¯å¼‚æ­¥çš„ï¼ŒLoader ä¼šåœ¨ callback ä¸­å›è°ƒç»“æœ
    var callback = this.async();
    someAsyncOperation(source, function(err, result, sourceMaps, ast) {
        // é€šè¿‡ callback è¿”å›å¼‚æ­¥æ‰§è¡Œåçš„ç»“æœ
        callback(err, result, sourceMaps, ast);
    });
};
```
## ğŸ˜Š å¦‚ä½•ç¼–å†™Pluginå—?ç¼–å†™è¿‡Pluginå—?

`Webpack`åŸºäºå‘å¸ƒè®¢é˜…æ¨¡å¼ï¼Œå’Œ`Node.js`ä¸­çš„`EventEmitter`ç›¸ä¼¼ã€‚`Webpack`åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¼šå¹¿æ’­äº‹ä»¶ï¼Œæ’ä»¶é€šè¿‡ç›‘å¬è¿™äº›äº‹ä»¶ï¼Œå°±å¯ä»¥åœ¨ç‰¹å®šçš„é˜¶æ®µæ‰§è¡Œè‡ªå·±çš„æ’ä»¶ä»»åŠ¡ï¼Œä»è€Œå®ç°è‡ªå·±æƒ³è¦çš„åŠŸèƒ½ã€‚`Compiler`å’Œ`Compilation`æ˜¯`Webpack`ä¸¤ä¸ªéå¸¸æ ¸å¿ƒçš„å¯¹è±¡ï¼Œå…¶ä¸­`Compiler`æš´éœ²äº†å’Œ`Webpack`æ•´ä¸ªç”Ÿå‘½å‘¨æœŸç›¸å…³çš„é’©å­ï¼ˆcompiler-hooksï¼‰ï¼Œè€Œ`Compilation`åˆ™æš´éœ²äº†ä¸æ¨¡å—å’Œä¾èµ–æœ‰å…³çš„ç²’åº¦æ›´å°çš„äº‹ä»¶é’©å­ï¼ˆCompilation Hooksï¼‰ã€‚

ä¸€ä¸ªæœ€ç®€å•çš„`Plugin`æºç å¦‚ä¸‹ï¼š

```js
class BasicPlugin{
  // åœ¨æ„é€ å‡½æ•°ä¸­è·å–ç”¨æˆ·ç»™è¯¥æ’ä»¶ä¼ å…¥çš„é…ç½®
  constructor(options){
  }

  // Webpack ä¼šè°ƒç”¨ BasicPlugin å®ä¾‹çš„ apply æ–¹æ³•ç»™æ’ä»¶å®ä¾‹ä¼ å…¥ compiler å¯¹è±¡
  apply(compiler){
    compiler.plugin('compilation',function(compilation) {
    })
  }
}

// å¯¼å‡º Plugin
module.exports = BasicPlugin;
```

`Webpack`å¯åŠ¨åï¼Œåœ¨è¯»å–é…ç½®çš„è¿‡ç¨‹ä¸­ä¼šå…ˆåˆå§‹åŒ–ä¸€ä¸ª`BasicPlugin`çš„å®ä¾‹ã€‚åœ¨åˆå§‹åŒ–`Compiler`å¯¹è±¡åï¼Œå†è°ƒç”¨`basicPlugin.apply(compiler)`ç»™æ’ä»¶å®ä¾‹ä¼ å…¥`Compiler`å¯¹è±¡ã€‚ æ’ä»¶å®ä¾‹åœ¨è·å–åˆ°`Compiler`å¯¹è±¡åï¼Œå°±å¯ä»¥é€šè¿‡`compiler.plugin(äº‹ä»¶åç§°, å›è°ƒå‡½æ•°)`ç›‘å¬åˆ°`Webpack`å¹¿æ’­å‡ºæ¥çš„äº‹ä»¶ã€‚ å¹¶ä¸”å¯ä»¥é€šè¿‡`Compiler`å¯¹è±¡å»æ“ä½œ`Webpack`ã€‚

`Compiler`å’Œ`Compilation`éƒ½ç»§æ‰¿è‡ª`Tapable`ï¼Œå¯ä»¥ç›´æ¥åœ¨`Compiler`å’Œ`Compilation`å¯¹è±¡ä¸Šå¹¿æ’­å’Œç›‘å¬äº‹ä»¶ã€‚`compilation.apply`å’Œ`compilation.plugin`åŒç†ã€‚

```js
// å¹¿æ’­äº‹ä»¶
compiler.apply('event-name',params);

// ç›‘å¬äº‹ä»¶
compiler.plugin('event-name',function(params) {});
```

- æ’ä»¶å¿…é¡»æ˜¯ä¸€ä¸ªå‡½æ•°æˆ–è€…æ˜¯ä¸€ä¸ªåŒ…å«`apply`æ–¹æ³•çš„å¯¹è±¡ï¼Œè¿™æ ·æ‰èƒ½è®¿é—®`Compiler`å®ä¾‹ã€‚
- ä¼ ç»™æ¯ä¸ªæ’ä»¶çš„`Compiler`å’Œ`Compilation`å¯¹è±¡éƒ½æ˜¯åŒä¸€ä¸ªå¼•ç”¨ï¼Œè‹¥åœ¨ä¸€ä¸ªæ’ä»¶ä¸­ä¿®æ”¹äº†å®ƒä»¬èº«ä¸Šçš„å±æ€§ï¼Œä¼šå½±å“åé¢çš„æ’ä»¶;
- å¼‚æ­¥çš„äº‹ä»¶éœ€è¦åœ¨æ’ä»¶å¤„ç†å®Œä»»åŠ¡æ—¶è°ƒç”¨å›è°ƒå‡½æ•°(å¼‚æ­¥çš„äº‹ä»¶ä¼šé™„å¸¦ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå›è°ƒå‡½æ•°ï¼Œåœ¨æ’ä»¶å¤„ç†å®Œä»»åŠ¡æ—¶éœ€è¦è°ƒç”¨å›è°ƒå‡½æ•°)é€šçŸ¥`Webpack`è¿›å…¥ä¸‹ä¸€ä¸ªæµç¨‹ï¼Œä¸ç„¶ä¼šå¡ä½ã€‚
## ğŸ˜Š è¯´ä¸€è¯´Compileå¯¹è±¡

`Compiler`å¯¹è±¡åŒ…å«äº†`Webpack`ç¯å¢ƒæ‰€æœ‰çš„çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…å«`options`ï¼Œ`loaders`ï¼Œ`plugins`è¿™äº›ä¿¡æ¯ï¼Œè¿™ä¸ªå¯¹è±¡åœ¨`Webpack`å¯åŠ¨æ—¶å€™è¢«å®ä¾‹åŒ–ï¼Œå®ƒæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œå¯ä»¥ç®€å•åœ°æŠŠå®ƒç†è§£ä¸º`Webpack`å®ä¾‹ã€‚
## ğŸ˜Š è¯´ä¸€è¯´Compilationå¯¹è±¡

`Compilation`å¯¹è±¡åŒ…å«äº†å½“å‰çš„æ¨¡å—èµ„æºã€ç¼–è¯‘ç”Ÿæˆèµ„æºã€å˜åŒ–çš„æ–‡ä»¶ç­‰ã€‚å½“`Webpack`ä»¥å¼€å‘æ¨¡å¼è¿è¡Œæ—¶ï¼Œæ¯å½“æ£€æµ‹åˆ°ä¸€ä¸ªæ–‡ä»¶å˜åŒ–ï¼Œä¸€æ¬¡æ–°çš„`Compilation`å°†è¢«åˆ›å»ºã€‚`Compilation`å¯¹è±¡ä¹Ÿæä¾›äº†å¾ˆå¤šäº‹ä»¶å›è°ƒä¾›æ’ä»¶åšæ‰©å±•ã€‚é€šè¿‡`Compilation`ä¹Ÿèƒ½è¯»å–åˆ°`Compiler`å¯¹è±¡ã€‚

`Compiler`å’Œ`Compilation`çš„åŒºåˆ«åœ¨äºï¼š`Compiler`ä»£è¡¨äº†æ•´ä¸ª`Webpack`ä»å¯åŠ¨åˆ°å…³é—­çš„ç”Ÿå‘½å‘¨æœŸï¼Œè€Œ `Compilation`åªæ˜¯ä»£è¡¨äº†ä¸€æ¬¡æ–°çš„ç¼–è¯‘ã€‚
## ğŸ˜Š äº†è§£Tree-shakingå—?Tree-shakingçš„åŸç†è¯´ä¸€è¯´?

`JavaScript`ç»å¤§å¤šæ•°æƒ…å†µéœ€è¦é€šè¿‡ç½‘ç»œè¿›è¡ŒåŠ è½½ï¼Œç„¶åæ‰§è¡Œï¼ŒåŠ è½½çš„æ–‡ä»¶å¤§å°è¶Šå°ï¼Œæ•´ä½“æ‰§è¡Œæ—¶é—´æ›´çŸ­ï¼Œæ‰€ä»¥é€šè¿‡`Tree-shaking`å°†æ²¡æœ‰ä½¿ç”¨çš„æ¨¡å—åˆ é™¤, å»é™¤æ— ç”¨ä»£ç ä»¥å‡å°‘æ–‡ä»¶ä½“ç§¯ï¼Œå¯¹`JavaScript`æ¥è¯´å¾ˆæœ‰æ„ä¹‰ã€‚
### Tree-shakingçš„åŸç†

é¦–å…ˆäº†è§£ä¸‹`Dead Code`çš„æ¦‚å¿µã€‚`Dead Code`æŒ‡é‚£äº›ä»£ç ä¸ä¼šè¢«æ‰§è¡Œï¼Œä¸å¯åˆ°è¾¾ï¼›ä»£ç æ‰§è¡Œçš„ç»“æœä¸ä¼šè¢«ç”¨åˆ°ï¼›ä»£ç åªä¼šå½±å“æ­»å˜é‡ï¼ˆåªå†™ä¸è¯»ï¼‰çš„ä»£ç ã€‚

1. å¯¹äº`Dead Code`ï¼Œ`Tree-shaking`ä¼šåŸºäºASTåˆ†æï¼Œä»¥åˆ é™¤æ— ç”¨çš„ä»£ç ã€‚
2. å¯¹äºæ— ç”¨çš„æ¨¡å—ä»£ç ã€‚`Tree-shaking`**ä¾èµ–äºES6çš„æ¨¡å—ç‰¹æ€§**ã€‚ç”±äºES6æ¨¡å—ä¾èµ–å…³ç³»æ˜¯ç¡®å®šçš„ï¼Œå’Œè¿è¡Œæ—¶çš„çŠ¶æ€æ— å…³ï¼Œå¯ä»¥è¿›è¡Œå¯é çš„é™æ€åˆ†æï¼Œè¿™æ˜¯`Tree-shaking`çš„åŸºç¡€ã€‚æ‰€ä»¥å¿…é¡»ä½¿ç”¨ES6æ¨¡å—çš„è¯­æ³•æ‰èƒ½è¿›è¡Œå¯¹æ— ç”¨æ¨¡å—ä»£ç çš„`Tree-shaking`ã€‚

## ğŸ˜Š è¯´ä¸€è¯´çƒ­æ›´æ–°çš„åŸç†?

![image.png](https://i.loli.net/2021/03/31/QVpyIaE1PioUOXA.png)

`Webpack`çš„çƒ­æ›´æ–°åˆç§°çƒ­æ›¿æ¢ï¼ˆHot Module Replacementï¼‰ï¼Œç¼©å†™ä¸º`HMR`ã€‚ è¿™ä¸ªæœºåˆ¶å¯ä»¥åšåˆ°ä¸ç”¨åˆ·æ–°æµè§ˆå™¨è€Œå°†æ–°å˜æ›´çš„æ¨¡å—æ›¿æ¢æ‰æ—§çš„æ¨¡å—ã€‚

ç¬¬ä¸€æ­¥, åœ¨`Webpack`çš„`watch`æ¨¡å¼ä¸‹ï¼Œæ–‡ä»¶ç³»ç»Ÿä¸­æŸä¸€ä¸ªæ–‡ä»¶å‘ç”Ÿä¿®æ”¹ï¼Œ`Webpack`ç›‘å¬åˆ°æ–‡ä»¶å˜åŒ–ï¼Œä¼šé‡æ–°æ‰“åŒ…ï¼Œå¹¶å°†æ‰“åŒ…åçš„ä»£ç é€šè¿‡ç®€å•çš„`JavaScript`å¯¹è±¡ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚ä¸ç”Ÿæˆæ–‡ä»¶çš„åŸå› å°±åœ¨äºè®¿é—®å†…å­˜ä¸­çš„ä»£ç æ¯”è®¿é—®æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æ›´å¿«ï¼Œä¹Ÿå‡å°‘äº†ä»£ç å†™å…¥æ–‡ä»¶çš„å¼€é”€ã€‚`webpack-dev-middleware`ä¼šä½¿ç”¨`memory-fs`å°†`Webpack`åŸæœ¬çš„`outputFileSystem`æ›¿æ¢æˆäº†`MemoryFileSystem`å®ä¾‹ã€‚è¿™æ ·`bundle.js`çš„ä»£ç å°±ä¼šé€šè¿‡ç®€å•`Javascript`å¯¹è±¡ä¿å­˜åœ¨äº†å†…å­˜ä¸­ã€‚å½“æµè§ˆå™¨è¯·æ±‚`bundle.js`æ–‡ä»¶ä¼šä»å†…å­˜ä¸­ç›´æ¥è¯»å–ä»£ç ã€‚è€Œä¸æ˜¯ä»æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–ä»£ç ã€‚

```js
// æ›¿æ¢fsæ¨¡å—, å®ç°ä»å†™å…¥æ–‡ä»¶å˜ä¸ºå†™å…¥å†…å­˜
if(isMemoryFs) {
    fs = compiler.outputFileSystem;
} else {
    fs = compiler.outputFileSystem = new MemoryFileSystem();
}
```

ç¬¬äºŒæ­¥, å¯åŠ¨`WebpackdevServer`å, ä¼šä½¿ç”¨`sockjs`åœ¨æœåŠ¡å™¨ç«¯å’Œæµè§ˆå™¨ç«¯å»ºç«‹ä¸€ä¸ª`WebSocket`ï¼Œ é€šè¿‡`WebSocket`å°†`Webpack`ç¼–è¯‘å’Œæ‰“åŒ…çš„å„ä¸ªé˜¶æ®µçŠ¶æ€å‘ŠçŸ¥æµè§ˆå™¨ã€‚`webpack-dev-server`ä¼šç›‘å¬`compile`çš„`done`äº‹ä»¶ï¼Œå½“`compile`å®Œæˆåï¼Œ`webpack-dev-server`é€šè¿‡`_sendStatus`æ–¹æ³•å°†ç¼–è¯‘æ‰“åŒ…åçš„æ–°æ¨¡å—`hash`å€¼å‘é€åˆ°æµè§ˆå™¨ç«¯ã€‚

```js
compiler.plugin('done', (stats) => {
  // è°ƒç”¨_sendStatusï¼Œå‘é€æ–°æ¨¡å—çš„hashå€¼ç»™æµè§ˆå™¨
  this._sendStats(this.sockets, stats.toJson(clientStats));
  this._stats = stats;
});

Server.prototype._sendStats = function (sockets, stats, force) {
  if (!force && stats &&
  (!stats.errors || stats.errors.length === 0) && stats.assets &&
  stats.assets.every(asset => !asset.emitted)
  ) { return this.sockWrite(sockets, 'still-ok'); }
  this.sockWrite(sockets, 'hash', stats.hash);
  if (stats.errors.length > 0) { this.sockWrite(sockets, 'errors', stats.errors); } 
  else if (stats.warnings.length > 0) { this.sockWrite(sockets, 'warnings', stats.warnings); }      else { this.sockWrite(sockets, 'ok'); }
};
```

ç¬¬ä¸‰æ­¥, `wbpack-dev-server`ä¿®æ”¹äº†`webpack`é…ç½®ä¸­çš„`entry`å±æ€§å¯¹åº”çš„æ–‡ä»¶ï¼Œåœ¨é‡Œé¢æ·»åŠ äº†`webpack-dev-client`çš„ä»£ç ï¼Œè¿™æ ·æ‰“åŒ…å`bundle.js`æ–‡ä»¶ä¸­å°±ä¼šæœ‰æ¥æ”¶`WebSocket`æ¶ˆæ¯çš„ä»£ç äº†ã€‚`webpack-dev-server/client`å½“æ¥æ”¶åˆ°`type`ä¸º `hash`æ¶ˆæ¯åä¼šå°†`hash`å€¼æš‚å­˜èµ·æ¥ï¼Œå½“æ¥æ”¶åˆ°`type`ä¸º`ok`çš„æ¶ˆæ¯åå¯¹åº”ç”¨æ‰§è¡Œ`reload`æ“ä½œã€‚åœ¨`reload`æ“ä½œä¸­ï¼Œ`webpack-dev-server/client`ä¼šæ ¹æ®`hot`é…ç½®å†³å®šæ˜¯åˆ·æ–°æµè§ˆå™¨è¿˜æ˜¯å¯¹ä»£ç è¿›è¡Œçƒ­æ›´æ–°ï¼ˆHMRï¼‰ã€‚

åœ¨æ¥æ”¶åˆ°`hash`æ¶ˆæ¯åï¼Œå°†`hash`ä¿å­˜åˆ°`currentHash`å˜é‡ä¸­ï¼Œå½“æ¥æ”¶åˆ°`ok`æ¶ˆæ¯å, è¿›è¡Œ`reload`æ“ä½œã€‚å¦‚æœé…ç½®äº†æ¨¡å—çƒ­æ›´æ–°ï¼Œå°±è°ƒç”¨`webpack/hot/emitter`å°†æœ€æ–°`hash`å€¼å‘é€ç»™`webpack`ï¼Œç„¶åå°†æ§åˆ¶æƒäº¤ç»™`webpack`å®¢æˆ·ç«¯ä»£ç ã€‚å¦‚æœæ²¡æœ‰é…ç½®æ¨¡å—çƒ­æ›´æ–°ï¼Œå°±ç›´æ¥è°ƒç”¨`location.reload`æ–¹æ³•åˆ·æ–°é¡µé¢ã€‚

```js
// hashæ¶ˆæ¯çš„å¤„ç†
function msgHash(hash) {
  currentHash = hash;
}
// okæ¶ˆæ¯å‡ºç‚‰
function msgOk() {
  // æ‰§è¡Œreloadæ“ä½œ
  reloadApp();
}

function reloadApp() {
  // ...
  if (hot) {
    log.info('[WDS] App hot update...');
    const hotEmitter = require('webpack/hot/emitter');
    hotEmitter.emit('webpackHotUpdate', currentHash);
    // ...
  } else {
    log.info('[WDS] App updated. Reloading...');
    self.location.reload();
  }
}
```

ç¬¬å››æ­¥, `webpack/hot/dev-server`ä¼šç›‘å¬ç¬¬ä¸‰æ­¥`webpack-dev-server/client`å‘é€çš„`webpackHotUpdate`çš„æ¶ˆæ¯ã€‚è°ƒç”¨ `webpack/lib/HotModuleReplacement.runtime`ï¼ˆç®€ç§° HMR runtimeï¼‰ä¸­çš„`check`æ–¹æ³•ï¼Œæ£€æµ‹æ˜¯å¦æœ‰æ–°çš„æ›´æ–°ï¼Œåœ¨`check` è¿‡ç¨‹ä¸­ä¼šåˆ©ç”¨`webpack/lib/JsonpMainTemplate.runtime`ï¼ˆç®€ç§° jsonp runtimeï¼‰ä¸­çš„ä¸¤ä¸ªæ–¹æ³• `hotDownloadUpdateChunk`å’Œ`hotDownloadManifest`ã€‚

- `hotDownloadManifest`æ˜¯è°ƒç”¨`ajax`å‘æœåŠ¡ç«¯è¯·æ±‚æ˜¯å¦æœ‰æ›´æ–°çš„æ–‡ä»¶ï¼Œå¦‚æœæœ‰å°†å‘**æ›´æ–°çš„æ–‡ä»¶åˆ—è¡¨**è¿”å›æµè§ˆå™¨ç«¯ã€‚
- `hotDownloadUpdateChunk`æ–¹æ³•æ˜¯é€šè¿‡`jsonp`è¯·æ±‚æœ€æ–°çš„æ¨¡å—ä»£ç ã€‚ä¹‹åå°†ä»£ç è¿”å›ç»™`HMR runtime`ï¼Œ`HMR runtime`ä¼šæ ¹æ®è¿”å›çš„æ–°æ¨¡å—ä»£ç åšè¿›ä¸€æ­¥å¤„ç†ï¼Œå¯èƒ½æ˜¯åˆ·æ–°é¡µé¢ï¼Œä¹Ÿå¯èƒ½æ˜¯å¯¹æ¨¡å—è¿›è¡Œçƒ­æ›´æ–°ã€‚

ä¸¤æ¬¡è¯·æ±‚çš„éƒ½æ˜¯ä½¿ç”¨ä¸Šä¸€æ¬¡çš„`hash`å€¼æ‹¼æ¥çš„è¯·æ±‚æ–‡ä»¶åï¼Œ`hotDownloadManifest`æ–¹æ³•è¿”å›çš„æ˜¯æœ€æ–°çš„`hash`å€¼ï¼Œ`hotDownloadUpdateChunk`æ–¹æ³•è¿”å›çš„å°±æ˜¯æœ€æ–°`hash`å€¼å¯¹åº”çš„ä»£ç å—ã€‚ç„¶åå°†æ–°çš„ä»£ç å—è¿”å›ç»™`HMR runtime`ï¼Œè¿›è¡Œæ¨¡å—çƒ­æ›´æ–°ã€‚


ç¬¬äº”æ­¥, æ¨¡å—çƒ­æ›´æ–°,å‘ç”Ÿåœ¨`HMR runtime`ä¸­çš„`hotApply`æ–¹æ³•ä¸­ã€‚æ¨¡å—çƒ­æ›¿æ¢ä¸»è¦åˆ†ä¸‰ä¸ªé˜¶æ®µã€‚ç¬¬ä¸€é˜¶æ®µï¼Œæ‰¾å‡ºè¿‡æœŸçš„æ¨¡å—å’Œä¾èµ–å…³ç³»ã€‚ç¬¬äºŒä¸ªé˜¶æ®µä»ç¼“å­˜ä¸­åˆ é™¤è¿‡æœŸçš„æ¨¡å—å’Œä¾èµ–ã€‚ç¬¬ä¸‰ä¸ªé˜¶æ®µæ˜¯å°†æ–°çš„æ¨¡å—æ·»åŠ åˆ° modules ä¸­ï¼Œå½“ä¸‹æ¬¡è°ƒ`__webpack_require__` (webpack é‡å†™çš„ require æ–¹æ³•)æ–¹æ³•çš„æ—¶å€™ï¼Œå°±æ˜¯è·å–åˆ°äº†æ–°çš„æ¨¡å—ä»£ç äº†ã€‚æ¨¡å—çƒ­æ›´æ–°çš„é”™è¯¯å¤„ç†ï¼Œå¦‚æœåœ¨çƒ­æ›´æ–°è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œçƒ­æ›´æ–°å°†å›é€€åˆ°åˆ·æ–°æµè§ˆå™¨ã€‚

ç¬¬å…­æ­¥, å½“ç”¨æ–°çš„æ¨¡å—ä»£ç æ›¿æ¢è€çš„æ¨¡å—åï¼Œä½†æ˜¯æˆ‘ä»¬çš„ä¸šåŠ¡ä»£ç å¹¶ä¸èƒ½çŸ¥é“ä»£ç å·²ç»å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦è°ƒç”¨`HMR`çš„`accept`æ–¹æ³•ã€‚

```js
if(module.hot) {
  module.hot.accept()
}
```
## ğŸ˜Š è¯´ä¸€è¯´å¦‚ä½•é…ç½®é•¿æ•ˆç¼“å­˜?

å°†`optimization`çš„`runtimeChunk`é…ç½®é¡¹è®¾ç½®ä¸º`true`, ä¼šé¢å¤–æ·»åŠ ä¸€ä¸ªåªå«æœ‰`runtime`çš„é¢å¤–`chunk`ã€‚è¿™ä¸ª`chunk`ä¸­åŒ…å«äº†`chunk`çš„æ˜ å°„å…³ç³»çš„åˆ—è¡¨ã€‚å¦‚æœä¸é¢å¤–æå–å‡ºæ¥ï¼Œå…¶ä»–çš„æ¨¡å—çš„æ”¹åŠ¨éƒ½ä¼šå¯¼è‡´`app.js`çš„hashçš„æ”¹å˜ã€‚ä»è€Œå¯¼è‡´ç¼“å­˜å¤±æ•ˆã€‚å¦å¤–æˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªé¢å¤–çš„`chunk`çš„å†…å®¹ï¼Œä½¿ç”¨`InlineSourcePlugin`æ’ä»¶ç›´æ¥æ·»åŠ åˆ°`html`ä¸­ï¼Œå‡å°‘äº†é¢å¤–çš„`http`è¯·æ±‚ã€‚
## ğŸ˜Š è¯´ä¸€è¯´å¦‚ä½•ä¼˜åŒ–webpackæ„å»ºé€Ÿåº¦?

1. ä½¿ç”¨`DllPlugin`å°†æ›´æ”¹ä¸é¢‘ç¹çš„ä»£ç è¿›è¡Œå•ç‹¬ç¼–è¯‘ã€‚è¿™å°†æ”¹å–„å¼•ç”¨ç¨‹åºçš„ç¼–è¯‘é€Ÿåº¦ï¼Œä½†æ˜¯å®ƒå¢åŠ äº†æ„å»ºè¿‡ç¨‹çš„å¤æ‚æ€§ã€‚
2. å°†`loaders`åº”ç”¨äºæœ€å°‘æ•°çš„å¿…è¦æ¨¡å—ä¸­ã€‚ï¼ˆæ¯”å¦‚è·³è¿‡`node_module`ä¸­çš„æ–‡ä»¶ï¼‰ã€‚
3. å¤šçº¿ç¨‹ï¼Œ`thread-loader`å¯ä»¥å°†éå¸¸æ¶ˆè€—èµ„æºçš„`loaders`è½¬å­˜åˆ°`worker pool`ä¸­ã€‚
4. ä½¿ç”¨`cache-loader`,  å¯ç”¨æŒä¹…åŒ–ç¼“å­˜ã€‚
5. åœ¨`production`æ¨¡å¼ä¸‹, å¦‚æ— å¿…è¦å¯ä»¥å…³é—­`Source Maps`ã€‚

## ğŸ˜Š è¯´ä¸€è¯´webpackå¦‚ä½•åšæ‹†åŒ…?è¯´ä¸€è¯´ä¸ºä»€ä¹ˆåšæ‹†åŒ…ï¼Ÿ

## ğŸ˜Š è¯´ä¸€è¯´css-loaderä¸style-loaderçš„åŒºåˆ«ï¼Ÿ

- css-loader, ç”¨æ¥å¤„ç†å¯¼å…¥çš„cssæ¨¡å—
- style-loader, ç”¨æ¥åˆ›å»ºstyleæ ‡ç­¾ï¼Œæ’å…¥ç”±css-loaderå¤„ç†çš„æ ·å¼

## ğŸ˜Š webpackä¸­loaderè°ƒç”¨çš„é¡ºåº?

## ğŸ˜Š è¯´ä¸€è¯´ä»€ä¹ˆæ˜¯bundle, chunk, moduleçš„åŒºåˆ«?

![image.png](https://i.loli.net/2021/05/07/RXic8pqhtP6uoJj.png)

- æˆ‘ä»¬å†™çš„ä»£ç æ¨¡å—è¢«ç§°ä¸ºmodule
- webpackå†…éƒ¨æ‰“åŒ…æ—¶æ ¹æ®å¼•ç”¨å…³ç³»ç”Ÿæˆchunkæ–‡ä»¶
- webpackä¼šæŠŠchunkè¾“å‡ºä¸ºbundleæ–‡ä»¶ï¼Œbundleä¸­åŒ…å«æºä»£ç å’Œç¼–è¯‘çš„ä»£ç ã€‚

ä¸€èˆ¬æ¥è¯´ä¸€ä¸ªchunkå¯¹åº”ä¸€ä¸ªbundleã€‚moduleï¼Œchunk å’Œbundleå…¶å®å°±æ˜¯åŒä¸€ä»½é€»è¾‘ä»£ç åœ¨ä¸åŒè½¬æ¢åœºæ™¯ä¸‹çš„å–äº†ä¸‰ä¸ªåå­—ã€‚

## ğŸ˜Š è¯´ä¸€è¯´hashã€chunkhashã€contenthashçš„åŒºåˆ«ï¼Ÿ

- hashï¼Œhashå’Œé¡¹ç›®çš„æ„å»ºç›¸å…³ï¼Œæ–‡ä»¶åçš„hashå’Œé¡¹ç›®çš„æ„å»ºhashä¸€æ ·ã€‚åªè¦é¡¹ç›®ä¸­æœ‰ä¸€ä¸ªæ–‡ä»¶æ›´æ”¹ï¼Œæ„å»ºçš„hashå°±ä¼šæ›´æ”¹ï¼Œ
- chunkhashï¼Œchunkhashå’Œwebpackæ‰“åŒ…æ—¶äº§ç”Ÿçš„hashå†…å®¹ç›¸å…³
- contenthashï¼Œcontenthashå’Œmoduleå†…å®¹ç›¸å…³ï¼Œå¦‚æœæ–‡ä»¶å†…å®¹å‘ç”Ÿå˜åŒ–contenthashæ‰ä¼šå‘ç”Ÿå˜åŒ–

## ğŸ˜Š è¯´ä¸€è¯´filenameå’ŒchunkFilenameçš„åŒºåˆ«ï¼Ÿ

- filenameï¼Œæ‰“åŒ…åè¾“å‡ºçš„æ–‡ä»¶çš„åç§°ã€‚åˆ—åœ¨ç¨‹åºå…¥å£çš„æ–‡ä»¶ã€‚
- chunkFilenameï¼Œæœªåˆ—åœ¨ç¨‹åºå…¥å£çš„æ–‡ä»¶ï¼Œä½†åˆéœ€è¦æ‰“åŒ…çš„æ–‡ä»¶ã€‚ä¸€èˆ¬æŒ‡éœ€è¦æ‡’åŠ è½½çš„æ–‡ä»¶åç§°
## è¯´ä¸€è¯´Webpack5çš„æ–°ç‰¹æ€§?
